{% extends "base.html" %}

{% block title %}Gest√£o de Pedidos{% endblock %}

{% block content %}
  <h1>Gest√£o de Pedidos</h1>
  <hr>

  <button id="toggle-dnd" class="btn-small">üîÄ Reordenar Cards</button>

  <div class="grid">
    
    <div id="card-receber" data-id="card-receber" class="card">
      <div class="card-header">
        <h2>üìå Pedidos a Receber</h2>
      </div>
      <div class="card-body">
        <ul class="list">
          {% for cliente, dados in clientes_devedores.items() %}
          <li class="cliente-row">
            <span class="cliente-info">{{ dados["titulo"] }}</span>
            <span class="valor-info">{{ dados["valor"]|format_brl }}</span>
          </li>
          {% endfor %}

          <li class="total-row">
            <a href="{{ url_for('orders.areceber') }}" class="btn-small">Detalhes</a>
            <span>Total Clientes: {{ total_receber_val|format_brl }}</span>
          </li>
        </ul>
      </div>
    </div>

    <div id="card-menu" data-id="card-menu" class="card">
      <h2>üìÇ Menu</h2>
      <div class="menu-btns">
        <a href="{{ url_for('orders.detalhes', tipo='porcliente', filtro='naoentregues') }}" class="btn">Pedidos por Cliente</a>
        <a href="{{ url_for('orders.novo_pedido') }}" class="btn">‚ûï Novo Pedido</a>
        <a href="#" class="btn">Novo Menu Futuramente</a>
      </div>
    </div>

    <div id="card-prazo" data-id="card-prazo" class="card">
      <h2>‚è≥ Prazo de Entrega</h2>
      <ul class="list">
        <li>
          <div>
            <b>J√° era pra serem entregues:</b>
            {{ prazos["atrasados"]["qtd"] }} ({{ prazos["atrasados"]["val"]|format_brl }})
          </div>
          <a href="{{ url_for('orders.detalhes', tipo='prazo', filtro='atrasados') }}" class="btn-small">Detalhes</a>
        </li>
        <li>
          <div>
            <b>Para HOJE:</b>
            {{ prazos["hoje"]["qtd"] }} ({{ prazos["hoje"]["val"]|format_brl }})
          </div>
          <a href="{{ url_for('orders.detalhes', tipo='prazo', filtro='hoje') }}" class="btn-small">Detalhes</a>
        </li>
        <li>
          <div>
            <b>A partir de amanh√£:</b>
            {{ prazos["futuros"]["qtd"] }} ({{ prazos["futuros"]["val"]|format_brl }})
          </div>
          <a href="{{ url_for('orders.detalhes', tipo='prazo', filtro='futuro') }}" class="btn-small">Detalhes</a>
        </li>
      </ul>
    </div>

  <div id="card-status" data-id="card-status" class="card" style="padding: 14px 16px;">
    <h2>üìä Por Status</h2>
    {% for grupo, lista in cards_por_status.items() %}
    {% if lista %}
      <h3 class="grupo-titulo {% if grupo == 'Com Prazo' %}com-prazo{% else %}sem-prazo{% endif %}">
      {% if grupo == 'Com Prazo' %}
        ‚è±Ô∏è {{ grupo }}
      {% else %}
        ü¶∑ {{ grupo }}
      {% endif %}
      </h3>

      <ul class="list">
      {% for s in lista %}
      <li>
        <div>
        <b>{{ s.status }}:</b>
        {{ s.qtd }} ({{ s.val|format_brl }})
        </div>
        <a href="{{ url_for('orders.detalhes', tipo='porstatus', filtro=s.slug) }}" class="btn-small">Detalhes</a>
      </li>
      {% endfor %}
      </ul>
    {% endif %}
    {% endfor %}
  </div>


  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>


  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const grid = document.querySelector(".grid");
      const toggleDnD = document.getElementById("toggle-dnd");

      // Inicializa SortableJS (desktop + mobile)
      const sortable = new Sortable(grid, {
        animation: 150,
        disabled: true, // come√ßa desativado
        onEnd: salvarOrdem
      });

      // Alterna drag-and-drop ao clicar no bot√£o
    let dragEnabled = false;

    toggleDnD.addEventListener("click", () => {
      dragEnabled = !dragEnabled;
      sortable.option("disabled", !dragEnabled); // agora respeita o estado real
      toggleDnD.textContent = dragEnabled ? "‚úÖ Reordene os Cards" : "üîÄ Reordenar Cards";
    });


      // Fun√ß√£o para salvar ordem no backend
      function salvarOrdem() {
        const ordem = [...grid.querySelectorAll(".card")].map(c => c.id);
        // CORRE√á√ÉO NO FETCH: Usa url_for para garantir a rota certa
        fetch("{{ url_for('orders.salvar_layout') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ordem })
        });
      }

      // üîπ Reordenar conforme salvo no backend
      const ordemSalva = {{ ordem_salva|tojson }};
      if (ordemSalva.length > 0) {
        ordemSalva.forEach(cardId => {
          const card = document.getElementById(cardId);
          if (card) grid.appendChild(card);
        });
      }
    });
  </script>
  <script>
    // Salva a √∫ltima rota visitada antes de mudar de p√°gina
    document.addEventListener("DOMContentLoaded", () => {
      const currentPath = window.location.pathname;
      sessionStorage.setItem("ultima_rota", currentPath);
    });
  </script>

  
{% endblock %}