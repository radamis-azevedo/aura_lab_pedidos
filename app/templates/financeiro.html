{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro.css') }}">

<div class="finance-container">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #198754; font-weight: 700;">Financeiro</h3>
    </div>

    <div class="custom-card">
        
        <form method="POST" id="form-busca">
            <div class="search-box">
                <select name="cliente" class="search-select" required onchange="this.form.submit()">
                    <option value="">Selecione o Cliente...</option>
                    {% for c in clientes %}
                    <option value="{{ c }}" {% if c == cliente_atual %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="selecionar_cliente" value="1">
            </div>
        </form>

        {% if dados %}
        
        <div class="summary-row">
            <div class="summary-item">
                <span class="kpi-label">PEDIDOS</span>
                <div class="kpi-value text-primary">{{ dados.resumo.total_divida | format_brl }}</div>
            </div>
            <div class="summary-item">
                <span class="kpi-label">PAGO</span>
                <div class="kpi-value text-success">{{ dados.resumo.total_pago | format_brl }}</div>
            </div>
            <div class="summary-item">
                <span class="kpi-label">PENDENTE</span>
                <div class="kpi-value {% if dados.resumo.saldo_pendente > 0.01 %}text-danger{% else %}text-muted{% endif %}">
                    {{ dados.resumo.saldo_pendente | format_brl }}
                </div>
            </div>
        </div>

        <h5 style="font-size: 0.85rem; color: #555; margin-bottom: 12px; font-weight: 700; text-transform: uppercase;">Novo Pagamento</h5>
        <form method="POST" id="form-pagamento">
            <input type="hidden" name="cliente_hidden" value="{{ cliente_atual }}">
            <input type="hidden" name="registrar_pagamento" value="1">
            
            <div class="form-row">
                <div class="form-group-data">
                    <label class="form-label">Data</label>
                    <input type="date" name="data" class="form-input" required>
                </div>
                <div class="form-group-valor">
                    <label class="form-label">Valor</label>
                    <input type="number" step="0.01" name="valor" class="form-input fw-bold text-success text-right" placeholder="0,00" required>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <input type="text" name="obs" class="form-input" placeholder="Observa√ß√£o (Opcional)">
            </div>

            <button type="submit" class="btn-confirm">CONFIRMAR PAGAMENTO</button>
        </form>

        <button type="button" id="btnExtrato" onclick="toggleExtrato()" class="btn-toggle-extrato">
            üìÇ Ver Extrato / Confer√™ncia
        </button>

        <div id="areaExtrato" class="hidden">
            <ul class="nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" onclick="switchTab('pedidos')" id="tab-pedidos">Pedidos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="switchTab('historico')" id="tab-historico">Hist√≥rico</a>
                </li>
            </ul>

            <div id="content-pedidos">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Dt. Ent</th>
                            <th class="col-center">Pg?</th>
                            <th class="col-right">Valor</th>
                            <th>Paciente</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in dados.pedidos %}
                        <tr>
                            <td style="color: #666;">#{{ '%03d' % p.NR_PED|int }}</td>
                            
                            <td>{{ p.DT_ENTREG[:5] }}</td>
                            
                            <td class="col-center">
                                <span class="status-dot {% if p.PAGO == 'SIM' %}pago{% else %}pendente{% endif %}"></span>
                            </td>
                            
                            <td class="col-right">{{ p.VLR_PED|replace('R$', '')|trim }}</td>
                            
                            <td style="font-size: 0.8rem;">{{ p.PACIENTE[:15] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div id="content-historico" class="hidden">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th style="width: 30px;"></th> <th class="col-center">Data</th>
                            <th class="col-center">Valor</th>
                            <th>Obs</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pg in dados.pagamentos %}
                        <tr>
                            <td>
                                <form action="{{ url_for('finance.excluir_pagamento') }}" method="POST" class="form-excluir">
                                    <input type="hidden" name="row_index" value="{{ pg.row_index }}">
                                    <input type="hidden" name="cliente_hidden" value="{{ cliente_atual }}">
                                    <button type="submit" class="btn-trash">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                            <td class="col-center">{{ pg.DT_RECEB }}</td>
                            <td class="col-center text-success fw-bold">{{ pg.VLR_RECEB|replace('R$', '')|trim }}</td>
                            <td style="color: #777;">{{ pg.OBS }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% else %}
        <div style="text-align: center; padding: 40px; color: #999;">
            <i class="fas fa-hand-holding-usd fa-2x mb-3" style="opacity: 0.3;"></i><br>
            Selecione um cliente acima
        </div>
        {% endif %}

    </div>

    <div style="text-align: center; margin-top: 30px;">
        <a href="{{ url_for('dashboard.index') }}" style="text-decoration: none; color: #666; font-size: 0.9rem;">
            ‚¨ÖÔ∏è Voltar ao Menu
        </a>
    </div>

</div>


<div id="loader-overlay">
        <div class="spinner"></div>
        <div id="loader-msg" class="loader-text">Processando...</div>
    </div>

    <script src="{{ url_for('static', filename='js/financeiro.js') }}"></script>

{% endblock %}