{% extends "base.html" %}

{% block title %}Gest√£o de Pedidos{% endblock %}

{% block content %}
  <div class="header-action">
      <h1>Gest√£o de Pedidos</h1>
      <button id="toggle-dnd" class="btn-small"><i class="fas fa-random"></i> Reordenar Cards</button>
  </div>
  <hr>

  <div class="grid">
    
    <div id="card-receber" data-id="card-receber" class="card">
      <div class="card-header">
        <h2><i class="fas fa-thumbtack text-danger"></i> Pedidos a Receber</h2>
      </div>
      <div class="card-body">
        <ul class="list">
          {% for cliente, dados in clientes_devedores.items() %}
          <li class="cliente-row">
            <span class="cliente-info">{{ dados["titulo"] }}</span>
            <span class="valor-info">{{ dados["valor"]|format_brl }}</span>
          </li>
          {% endfor %}

          <li class="total-row">
            <a href="{{ url_for('orders.areceber') }}" class="btn-small">Detalhes</a>
            <span>Total: {{ total_receber_val|format_brl }}</span>
          </li>
        </ul>
      </div>
    </div>

    <div id="card-menu" data-id="card-menu" class="card">
      <h2><i class="fas fa-folder-open text-primary"></i> Menu</h2>
      <div class="menu-btns">
        <a href="{{ url_for('orders.detalhes', tipo='porcliente', filtro='naoentregues') }}" class="btn">
            <i class="fas fa-users"></i> Pedidos por Cliente
        </a>
        <a href="{{ url_for('orders.novo_pedido') }}" class="btn">
            <i class="fas fa-plus-circle"></i> Novo Pedido
        </a>
        <a href="{{ url_for('finance.index') }}" class="btn">
            <i class="fas fa-wallet"></i> Financeiro
        </a>
      </div>
    </div>

    <div id="card-prazo" data-id="card-prazo" class="card">
      <h2><i class="fas fa-hourglass-half text-warning"></i> Prazo de Entrega</h2>
      <ul class="list">
        <li>
          <div>
            <b>Atrasados:</b>
            {{ prazos["atrasados"]["qtd"] }} ({{ prazos["atrasados"]["val"]|format_brl }})
          </div>
          <a href="{{ url_for('orders.detalhes', tipo='prazo', filtro='atrasados') }}" class="btn-small">Ver</a>
        </li>
        <li>
          <div>
            <b>Para HOJE:</b>
            {{ prazos["hoje"]["qtd"] }} ({{ prazos["hoje"]["val"]|format_brl }})
          </div>
          <a href="{{ url_for('orders.detalhes', tipo='prazo', filtro='hoje') }}" class="btn-small">Ver</a>
        </li>
        <li>
          <div>
            <b>Futuros:</b>
            {{ prazos["futuros"]["qtd"] }} ({{ prazos["futuros"]["val"]|format_brl }})
          </div>
          <a href="{{ url_for('orders.detalhes', tipo='prazo', filtro='futuro') }}" class="btn-small">Ver</a>
        </li>
      </ul>
    </div>

    <div id="card-status" data-id="card-status" class="card" style="padding: 14px 16px;">
        <h2><i class="fas fa-chart-pie text-info"></i> Por Status</h2>
        {% for grupo, lista in cards_por_status.items() %}
        {% if lista %}
        <h3 class="grupo-titulo" style="margin-top: 10px; font-size: 0.9rem; text-transform: uppercase; color: #666;">
            {% if grupo == 'Com Prazo' %}
                ‚è±Ô∏è {{ grupo }}
            {% else %}
                ü¶∑ {{ grupo }}
            {% endif %}
        </h3>

        <ul class="list">
            {% for s in lista %}
            <li>
                <div>
                <b>{{ s.status }}:</b>
                {{ s.qtd }} ({{ s.val|format_brl }})
                </div>
                <a href="{{ url_for('orders.detalhes', tipo='porstatus', filtro=s.slug) }}" class="btn-small">Ver</a>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endfor %}
    </div>

  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // 1. Salvar Rota
      sessionStorage.setItem("ultima_rota", window.location.pathname);

      // 2. Drag and Drop
      const grid = document.querySelector(".grid");
      const toggleDnD = document.getElementById("toggle-dnd");

      const sortable = new Sortable(grid, {
        animation: 150,
        disabled: true, 
        handle: ".card-header, h2", // Melhor usabilidade: s√≥ arrasta pelo t√≠tulo
        onEnd: salvarOrdem
      });

      let dragEnabled = false;

      toggleDnD.addEventListener("click", () => {
        dragEnabled = !dragEnabled;
        sortable.option("disabled", !dragEnabled);
        
        if (dragEnabled) {
            toggleDnD.innerHTML = '<i class="fas fa-check"></i> Salvar Ordem';
            toggleDnD.classList.add('btn-active'); // Se tiver estilo para bot√£o ativo
            grid.classList.add('reordering'); // Para CSS visual se quiser
        } else {
            toggleDnD.innerHTML = '<i class="fas fa-random"></i> Reordenar Cards';
            toggleDnD.classList.remove('btn-active');
            grid.classList.remove('reordering');
        }
      });

      function salvarOrdem() {
        const ordem = [...grid.querySelectorAll(".card")].map(c => c.id);
        fetch("{{ url_for('orders.salvar_layout') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ordem })
        });
      }

      // 3. Restaurar Ordem
      const ordemSalva = {{ ordem_salva|tojson }};
      if (ordemSalva && ordemSalva.length > 0) {
        ordemSalva.forEach(cardId => {
          const card = document.getElementById(cardId);
          if (card) grid.appendChild(card);
        });
      }
    });
  </script>
{% endblock %}