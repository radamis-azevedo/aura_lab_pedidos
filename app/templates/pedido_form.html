{% extends "base.html" %}

{% block title %}
    {% if modo == 'editar' %}Editar Pedido #{{ nr_ped }}{% else %}Novo Pedido{% endif %}
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pedido_form.css') }}">
{% endblock %}

{% block content %}

<div id="feedback" class="alert" style="display:none; margin-bottom: 15px; padding: 15px; border-radius: 8px;"></div>

<div class="form-card">
    <h2 class="form-title">
        {% if modo == 'editar' %}
            <i class="fas fa-edit"></i> Editar Pedido #{{ "%02d"|format(nr_ped|int) }}
        {% else %}
            <i class="fas fa-plus-circle"></i> Novo Pedido
        {% endif %}
    </h2>

    <form id="pedidoForm" method="POST">
        
        <div class="form-row">
            <label>Data do Pedido:</label>
            {% if modo == 'editar' %}
                {% set dt_view = dt_pedido %}
                {% if dt_pedido and dt_pedido|length >= 16 %}
                   {% set dt_view = dt_pedido[8:10] + '/' + dt_pedido[5:7] + '/' + dt_pedido[0:4] + ' ' + dt_pedido[11:16] %}
                {% endif %}
                <input type="text" class="form-control" value="{{ dt_view }}" disabled style="background:#f8f9fa; color: #333; text-align: center; font-weight: bold;">
                <input type="hidden" name="dt_pedido" value="{{ dt_pedido }}">
            {% else %}
                <input type="datetime-local" name="dt_pedido" id="dt_pedido" class="form-control" value="{{ dt_pedido }}" required style="text-align: center;">
            {% endif %}
        </div>

        <div class="form-row">
            <label>Cliente:</label>
            <select name="cliente" id="cliente" class="form-control" required>
                <option value="">-- selecione --</option>
                {% for c in clientes %}
                <option value="{{ c }}" {% if c == cliente_atual %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-row">
            <label>Paciente:</label>
            <input type="text" name="paciente" id="paciente" class="form-control" value="{{ paciente_atual }}" required>
        </div>

        <div class="form-row">
            <label>Observação:</label>
            <input type="text" name="obs_ped" id="obs_ped" class="form-control" value="{{ obs_atual }}">
        </div>

        <h4 style="margin-top: 30px; margin-bottom: 10px; color: #333; font-weight: 700; font-size: 1.1rem;">Itens do Pedido</h4>
        
        <div class="form-row">
            <label>Produto:</label>
            <select id="produto" class="form-control">
                <option value="">-- selecione --</option>
                {% for p in produtos %}
                <option value="{{ p.PRODUTO }}" data-vlr="{{ p.VLR_CAT }}">
                    {{ p.PRODUTO }} - {{ p.VLR_CAT }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="row-flex">
            <div>
                <label>Cor:</label>
                <input type="text" id="cor" class="form-control" placeholder="Cor">
            </div>
            <div>
                <label>Qtd:</label>
                <input type="number" id="qtde" class="form-control" min="1" placeholder="1">
            </div>
            <div>
                <label>Valor:</label>
                <input type="text" id="valor_cobrado" class="form-control" placeholder="0,00">
            </div>
        </div>

        <div class="form-row row-obs">
             <label class="label-center">Obs:</label>
             
             <div style="display: flex; gap: 8px;">
                <input type="text" id="obs_item" class="form-control" style="flex: 1;" placeholder="Opcional">
                <button type="button" class="btn-icon-only" onclick="adicionarItem()" title="Adicionar Item">
                    <i class="fas fa-plus"></i>
                </button>
             </div>
        </div>

        <div class="table-scroll-wrapper">
            <table class="table-itens" id="tabela-itens">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Qtd</th>
                        <th>Cor</th>
                        <th>Valor</th>
                        <th>Obs</th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in itens %}
                    <tr data-json='{{ {"produto":i.PRODUTO,"qtde":i.QTD_ITEM,"cor":i.COR,"valor":i.VLR_COB,"obs":i.OBS_ITEM}|tojson }}'>
                        <td>{{ i.PRODUTO }}</td>
                        <td>{{ i.QTD_ITEM }}</td>
                        <td>{{ i.COR }}</td>
                        <td>{{ i.VLR_COB }}</td>
                        <td>{{ i.OBS_ITEM }}</td>
                        <td><button type="button" class="btn-remove" onclick="removerLinha(this)">✕</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 25px;">
            <h4 style="color: #333; font-weight: 700; margin: 0; font-size: 1.1rem;">Terceirização</h4>
            <div class="switch-box" style="margin:0;">
                <label class="switch">
                    <input type="checkbox" id="toggle-custos" onchange="toggleCustos()" {% if custos and custos|length > 0 %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
            </div>
        </div>

        <div id="custos-section" style="display:none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #eee;">
            <div class="form-row">
                <label>Descrição:</label>
                <input type="text" id="desc-custo" class="form-control">
            </div>
            
            <div class="row-flex">
                <div style="flex: 1;">
                    <label>Qtd:</label>
                    <input type="number" id="qtd-custo" class="form-control" min="1">
                </div>
                <div style="flex: 1;">
                    <label>Valor Un:</label>
                    <input type="text" id="valor-custo" class="form-control">
                </div>
            </div>

             <div class="form-row row-obs">
                 <label class="label-center">Obs:</label>
                 
                 <div style="display: flex; gap: 8px;">
                    <input type="text" id="obs-custo" class="form-control" style="flex: 1;" placeholder="Opcional">
                    <button type="button" class="btn-icon-only" style="background-color: #6c757d;" onclick="adicionarCusto()" title="Incluir Custo">
                        <i class="fas fa-plus"></i>
                    </button>
                 </div>
            </div>
            
            <div class="table-scroll-wrapper">
                <table class="table-itens" id="tabela-custos">
                    <thead><tr><th>Descrição</th><th>Total</th><th>Obs</th><th></th></tr></thead>
                    <tbody>
                        {% for c in custos %}
                        <tr data-json='{{ {"desc":c.DESC_CUSTO,"qtd":c.QTD_CUSTO,"valor":c.VLR_UN_CUSTO,"obs":c.OBS_CUSTO}|tojson }}'>
                            <td>{{ c.DESC_CUSTO }}</td><td>{{ c.TOTAL_VIEW }}</td><td>{{ c.OBS_CUSTO }}</td>
                            <td><button type="button" class="btn-remove" onclick="removerLinha(this)">✕</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <input type="hidden" name="itens_json" id="itens_json">
        <input type="hidden" name="custos_json" id="custos_json">

        <div class="actions-footer">
            <button id="btnSalvar" type="submit" class="btn-save">
                <i class="fas fa-save"></i> Salvar
            </button>
             <a href="{{ url_for('dashboard.index') }}" class="btn-back">
                Voltar
            </a>
            {% if modo == 'editar' %}
            <button type="button" class="btn-delete" onclick="excluirPedido('{{ nr_ped }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>

    </form>
</div>

<div id="loader-overlay">
    <div class="spinner"></div>
    <div class="loader-text">Salvando...</div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.getElementById("produto").addEventListener("change", function() {
      const opt = this.options[this.selectedIndex];
      if(opt.getAttribute("data-vlr")) {
          let val = opt.getAttribute("data-vlr").replace("R$", "").trim();
          document.getElementById("valor_cobrado").value = val;
      }
    });

    function adicionarItem() {
        const produto = document.getElementById("produto").value;
        const qtde = document.getElementById("qtde").value;
        const cor = document.getElementById("cor").value;
        const valor = document.getElementById("valor_cobrado").value;
        const obs = document.getElementById("obs_item").value;

        if (!produto || !qtde || !valor) {
            alert("⚠️ Preencha Produto, Quantidade e Valor.");
            return;
        }

        let q = parseFloat(qtde.replace(",", ".")) || 0;
        let v = parseFloat(valor.replace(".", "").replace(",", ".")) || 0;
        let valorFmt = v.toLocaleString('pt-BR', {minimumFractionDigits: 2});

        const tbody = document.querySelector("#tabela-itens tbody");
        const tr = document.createElement("tr");

        const dados = { produto, qtde, cor, valor, obs };
        tr.dataset.json = JSON.stringify(dados);

        tr.innerHTML = `
            <td>${produto}</td>
            <td>${qtde}</td>
            <td>${cor}</td>
            <td>${valorFmt}</td>
            <td>${obs}</td>
            <td><button type="button" class="btn-remove" onclick="removerLinha(this)">✕</button></td>
        `;
        tbody.appendChild(tr);

        document.getElementById("qtde").value = "";
        document.getElementById("cor").value = "";
        document.getElementById("valor_cobrado").value = "";
        document.getElementById("obs_item").value = "";
        document.getElementById("produto").focus();
    }

    function adicionarCusto() {
        const desc = document.getElementById("desc-custo").value;
        const qtd = document.getElementById("qtd-custo").value;
        const valor = document.getElementById("valor-custo").value;
        const obs = document.getElementById("obs-custo").value;

        if (!desc || !qtd || !valor) {
            alert("⚠️ Preencha Descrição, Quantidade e Valor.");
            return;
        }

        let q = parseFloat(qtd.replace(",", ".")) || 0;
        let v = parseFloat(valor.replace(".", "").replace(",", ".")) || 0;
        let total = (q * v).toLocaleString('pt-BR', {minimumFractionDigits: 2});

        const tbody = document.querySelector("#tabela-custos tbody");
        const tr = document.createElement("tr");
        
        tr.dataset.json = JSON.stringify({ desc, qtd, valor, obs });
        tr.innerHTML = `
            <td>${desc}</td>
            <td>${total}</td>
            <td>${obs}</td>
            <td><button type="button" class="btn-remove" onclick="removerLinha(this)">✕</button></td>
        `;
        tbody.appendChild(tr);

        document.getElementById("desc-custo").value = "";
        document.getElementById("qtd-custo").value = "";
        document.getElementById("valor-custo").value = "";
        document.getElementById("obs-custo").value = "";
    }

    function removerLinha(btn) { btn.closest("tr").remove(); }

    function toggleCustos() {
        const section = document.getElementById("custos-section");
        const check = document.getElementById("toggle-custos");
        section.style.display = check.checked ? "block" : "none";
    }
    document.addEventListener("DOMContentLoaded", toggleCustos);

    const form = document.getElementById("pedidoForm");
    const loader = document.getElementById("loader-overlay");

    form.addEventListener("submit", function(e) {
        e.preventDefault();
        
        const itensTr = document.querySelectorAll("#tabela-itens tbody tr");
        if (itensTr.length === 0) {
            alert("⚠️ Adicione pelo menos um item ao pedido.");
            return;
        }

        const itens = Array.from(itensTr).map(tr => JSON.parse(tr.dataset.json));
        document.getElementById("itens_json").value = JSON.stringify(itens);

        const custosTr = document.querySelectorAll("#tabela-custos tbody tr");
        const custos = Array.from(custosTr).map(tr => JSON.parse(tr.dataset.json));
        document.getElementById("custos_json").value = JSON.stringify(custos);

        loader.style.display = "flex";
        
        const formData = new FormData(form);
        
        fetch(window.location.pathname, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loader.style.display = "none";
            const fb = document.getElementById("feedback");
            fb.style.display = "block";
            
            if (data.sucesso) {
                fb.className = "alert alert-success";
                fb.innerHTML = `✅ <strong>Sucesso!</strong> Pedido salvo.`;
                setTimeout(() => { window.location.href = "{{ url_for('dashboard.index') }}"; }, 1500);
            } else {
                fb.className = "alert alert-danger";
                fb.innerHTML = `❌ <strong>Erro:</strong> ${data.erro}`;
            }
        })
        .catch(err => {
            loader.style.display = "none";
            alert("Erro de conexão.");
        });
    });

    function excluirPedido(nr_ped) {
        if(confirm("Tem certeza que deseja EXCLUIR este pedido?")) {
            loader.style.display = "flex";
            fetch(`/api/excluir_pedido/${nr_ped}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if(data.ok) {
                    window.location.href = "{{ url_for('dashboard.index') }}";
                } else {
                    alert("Erro: " + data.msg);
                    loader.style.display = "none";
                }
            });
        }
    }
</script>
{% endblock %}