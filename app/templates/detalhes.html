{% extends "base.html" %}

{% block title %}Detalhes - {{ filtro }}{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/detalhes.css') }}">
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 style="color:#007bff; font-weight:bold;">{{ filtro }}</h3>
</div>

{% if modo_view == 'lista' %}
    
    {% for cliente, lista_pedidos in agrupado.items() %}
    <div class="client-card">
        <div class="client-header">
            {{ cliente }}
        </div>

        <div class="table-scroll">
            <table class="table-lista">
                <thead>
                    <tr>
                        <th class="col-action"></th>
                        <th class="col-id">#</th>
                        <th class="col-status">Status</th>
                        <th class="col-paciente">Paciente</th>
                        <th class="col-data">Data</th> 
                        <th class="col-valor">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in lista_pedidos %}
                    <tr>
                        <td class="col-action">
                            <button type="button" class="btn-toggle-mini" 
                                    onclick="toggleDetails('details-{{ p.NR_PED }}')">
                                <i class="fas fa-plus"></i>
                            </button>
                        </td>

                        <td class="col-id">
                            <a href="{{ url_for('orders.editar_pedido', nr_ped=p.NR_PED) }}" class="order-link" title="Editar Pedido">
                                {{ "%03d"|format(p.NR_PED|int) }}
                            </a>
                        </td>

                        <td class="col-status">
                            <div class="status-wrapper">
                                <a href="{{ url_for('orders.status_pedido', nr_ped=p.NR_PED) }}" 
                                   style="text-decoration:none; margin-right: 2px;" 
                                   title="Ver Histórico">
                                    <i class="fas fa-circle" style="font-size: 0.65rem; color: 
                                        {% if 'entregue' in p.STATUS|lower or 'finalizado' in p.STATUS|lower %}#28a745
                                        {% elif 'produ' in p.STATUS|lower %}#ffc107
                                        {% elif 'atrasado' in p.STATUS|lower %}#dc3545
                                        {% else %}#6c757d{% endif %};">
                                    </i>
                                </a>

                                <span class="status-text">{{ p.STATUS }}</span>
                                
                                <a href="{{ url_for('orders.pagamento_pedido', nr_ped=p.NR_PED) }}" style="text-decoration:none;">
                                    {% if p.PAGO|lower in ['sim','s','true'] %}
                                        <i class="fas fa-check-circle text-success" style="font-size:0.9rem;"></i>
                                    {% else %}
                                        <i class="fas fa-sack-dollar icon-money"></i>
                                    {% endif %}
                                </a>
                            </div>
                        </td>

                        <td class="col-paciente">
                            {{ p.PACIENTE or '' }}
                        </td>

                        <td class="col-data">
                            {{ p.DT_PEDIDO|default('-', true) }}
                        </td>

                        <td class="col-valor">
                            R$ {{ p.VLR_NUM|default(0)|float|round(2) }}
                        </td>
                    </tr>

                    <tr id="details-{{ p.NR_PED }}" class="details-row">
                        <td colspan="6">
                            <div class="details-box">
                                
                                {% if p.ITENS %}
                                <div class="scroll-wrapper">
                                    <table class="mini-table">
                                        <thead>
                                            <tr>
                                                <th>Produto</th>
                                                <th class="num">Qtd</th>
                                                <th style="text-align:center;">Cor</th>
                                                <th class="num">Unit.</th>
                                                <th class="num">Total</th>
                                                <th>Obs</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in p.ITENS %}
                                            <tr>
                                                <td><strong>{{ item.PRODUTO }}</strong></td>
                                                <td class="num">{{ item.QTD_ITEM }}</td>
                                                <td style="text-align:center;">{{ item.COR }}</td>
                                                
                                                <td class="num">
                                                    {{ item.VLR_COB|replace('R$', '')|replace(' ', '') }}
                                                </td>
                                                
                                                <td class="num text-blue">
                                                    {% if item.TOTAL_VIEW %}
                                                        {{ item.TOTAL_VIEW|replace('R$', '')|replace(' ', '') }}
                                                    {% else %}
                                                        {{ item.TOTAL_PROD|replace('R$', '')|replace(' ', '') }}
                                                    {% endif %}
                                                </td>
                                                
                                                <td class="obs">{{ item.OBS_ITEM }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                    <div style="font-style:italic; color:#999; margin-bottom:10px;">Sem produtos cadastrados.</div>
                                {% endif %}

                                {% if p.CUSTOS %}
                                <div class="scroll-wrapper gap-top">
                                    <table class="mini-table">
                                        <thead>
                                            <tr>
                                                <th style="color:#dc3545;">Terceirização / Custo</th> 
                                                <th class="num">Qtd</th>
                                                <th class="num">Unit.</th>
                                                <th class="num">Total</th>
                                                <th>Obs</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for c in p.CUSTOS %}
                                            <tr>
                                                <td>{{ c.DESC_CUSTO }}</td>
                                                <td class="num">{{ c.QTD_CUSTO }}</td>
                                                <td class="num">
                                                    {{ c.VLR_UN_CUSTO|replace('R$', '')|replace(' ', '') }}
                                                </td>
                                                <td class="num text-red">
                                                    {% if c.TOTAL_VIEW %}
                                                        {{ c.TOTAL_VIEW|replace('R$', '')|replace(' ', '') }}
                                                    {% else %}
                                                        {{ c.VLR_TOT_CUSTO|replace('R$', '')|replace(' ', '') }}
                                                    {% endif %}
                                                </td>
                                                <td class="obs">{{ c.OBS_CUSTO }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}

                                {% if p.OBS_PED %}
                                    <div style="margin-top:10px; font-size:0.85rem; color:#444;">
                                        <span style="font-weight:bold; color:#dc3545;">Obs:</span> {{ p.OBS_PED }}
                                    </div>
                                {% endif %}

                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div> 
    </div>
    {% endfor %}

{% else %}
    {% endif %}

{% endblock %}

{% block scripts %}
<script>
    function toggleDetails(id) {
        var row = document.getElementById(id);
        if (row.style.display === "none" || row.style.display === "") {
            row.style.display = "table-row";
        } else {
            row.style.display = "none";
        }
    }
</script>
{% endblock %}