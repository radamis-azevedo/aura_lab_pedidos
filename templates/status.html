<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Status do Pedido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- responsivo -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <!-- TOPO -->
  <div class="top-bar">
    <div class="logo">
      <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='logo.png') }}" alt="Logo"></a>
    </div>
    <div class="user-info">
      <span>{{ usuario }}</span>
      <a href="{{ url_for('logout') }}" class="btn-small">Sair</a>
    </div>
  </div>

  <div class="status-container">
    <h2 class="status-header">Hist√≥rico do Pedido #{{ nr_ped }}</h2>

    <!-- ITENS DO PEDIDO -->
    <div class="table-wrapper">
      <table class="itens-table">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Qtd</th>
            <th>Cor</th>
            <th>Valor Unit√°rio</th>
            <th>Total</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody>
          {% for item in itens %}
          <tr>
            <td>{{ item.PRODUTO }}</td>
            <td>{{ item.QTD_ITEM }}</td>
            <td>{{ item.COR }}</td>
            <td>{{ item.VLR_COB }}</td>
            <td>{{ item.TOTAL_PROD }}</td>
            <td>{{ item.OBS }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- TABELA HIST√ìRICO -->
    <div class="table-wrapper">
      <table class="status-table">
        <thead>
          <tr>
            <th></th>
            <th>Status</th>
            <th>Data/Hora In√≠cio</th>
            <th>Prazo (dias)</th>
            <th>Data/Hora Prazo</th>
            <th>Obs</th>
            <th>Registro Status</th>
          </tr>
        </thead>
        <tbody>
          {% for h in historico %}
          <tr>
            <td class="edit-cell">
              <button class="edit-btn" 
                onclick="editarHistorico('{{ h.STATUS_HIST }}','{{ h.DT_HR_STATUS }}','{{ h.PRAZO_STATUS }}','{{ h.DT_HR_PRAZO }}','{{ h.OBS_STATUS }}','{{ h.row_index }}')">‚úèÔ∏è</button>
            </td>
            <td>{{ h.STATUS_HIST }}</td>
            <td>{{ h.DT_HR_STATUS }}</td>
            <td>{{ h.PRAZO_STATUS }}</td>
            <td>{{ h.DT_HR_PRAZO }}</td>
            <td>{{ h.OBS_STATUS }}</td>
            <td>{{ h.USUARIO }} em {{ h.DATA_HORA }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- üîî MENSAGENS DE FEEDBACK -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- FORMUL√ÅRIO PRINCIPAL -->
    <form method="POST" class="status-form" id="status-form">
      <h3 id="form-title">‚ûï Incluir Novo Status</h3>

      <!-- Campo oculto para row_index -->
      <input type="hidden" id="row_index" name="row_index">

      <!-- Linha 1: Status -->
      <div class="form-row">
        <label style="flex:1">
          Status:
          <select name="status" id="status" required>
            <option value="">-- selecione --</option>
            {% for s in status_options %}
              {% if loop.index0 > 0 %}
                <option value="{{ s }}">{{ s }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </label>
      </div>

      <!-- Linha 2: Data/Hora In√≠cio + Prazo -->
      <div class="form-row prazo-row">
        <label>
          Data/Hora In√≠cio:
          <input type="datetime-local" name="dt_hr_status" id="dt_hr_status" value="{{ now_str }}">
        </label>
        <label>
          Prazo (dias):
          <input type="number" name="prazo" id="prazo" min="0" max="99">
        </label>
      </div>

      <!-- Linha 3: Observa√ß√µes -->
      <div class="form-row">
        <label style="flex:1">
          Observa√ß√µes:
          <textarea name="obs" id="obs" rows="3"></textarea>
        </label>
      </div>

      <button type="submit">Salvar</button>
      <button type="button" class="cancel-btn" onclick="resetarFormulario()">Cancelar</button>
      <button type="submit" form="delete-form" id="delete-btn" class="delete-btn" style="display:none;">Excluir</button>
    </form>

    <!-- FORMUL√ÅRIO OCULTO DE EXCLUS√ÉO -->
    <form method="POST" id="delete-form" style="display:none;" onsubmit="return confirmarExclusao()"></form>

    <!-- BOT√ÉO VOLTAR NO RODAP√â -->
    <div style="margin-top:20px; text-align:center;">
      <a href="javascript:history.back()" class="back-btn">‚Üê Voltar</a>
    </div>
  </div>

  <script>
    const nr_ped = "{{ nr_ped }}";  // exp√µe o n√∫mero do pedido

    function editarHistorico(status, dt_hr_status, prazo, dt_hr_prazo, obs, row_index) {
      document.getElementById("form-title").textContent = "‚úèÔ∏è Editar Status";
      document.getElementById("status").value = status;
      document.getElementById("dt_hr_status").value = formatarInputDateTime(dt_hr_status);
      document.getElementById("prazo").value = prazo;
      document.getElementById("obs").value = obs;
      document.getElementById("row_index").value = row_index;
      document.getElementById("delete-btn").style.display = "inline-block";

      // configura a action do form oculto
      document.getElementById("delete-form").action = `/status/${nr_ped}/delete/${row_index}`;
    }

    function resetarFormulario() {
      document.getElementById("form-title").textContent = "‚ûï Incluir Novo Status";
      document.getElementById("status-form").reset();
      document.getElementById("dt_hr_status").value = new Date().toISOString().slice(0,16);
      document.getElementById("row_index").value = "";
      document.getElementById("delete-btn").style.display = "none";
      document.getElementById("delete-form").action = "";
    }

    function formatarInputDateTime(str) {
      if (!str) return "";
      const [data, hora] = str.split(" ");
      if (!data || !hora) return "";
      const [d, m, y] = data.split("/");
      const [hh, mm] = hora.split(":");
      return `${y}-${m}-${d}T${hh}:${mm}`;
    }

    function confirmarExclusao() {
      return confirm("‚ö†Ô∏è Deseja realmente excluir este hist√≥rico?");
    }

    resetarFormulario();
  </script>
</body>
</html>
