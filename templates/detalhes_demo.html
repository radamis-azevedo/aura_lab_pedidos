{% extends "base.html" %}

{% block title %}Detalhes{% endblock %}

{% block content %}
  <h2 class="titulo-detalhes {{ tipo }}">{{ filtro }}</h2>
  <hr>

  {% if tipo == "porcliente" %}
  <div class="switch-box">
    <label class="switch">
	  <input type="checkbox" id="toggle-entregues"
			 {% if filtro == "Pedidos por Cliente (todos)" %}checked{% endif %}>
	  <span class="slider round"></span>
	</label>
	<span class="switch-label">Mostrar pedidos entregues</span>
  </div>
  {% endif %}

  {% if agrupado %}
    {% for cliente, pedidos in agrupado.items() %}
      <div class="card cliente {{ tipo }}">
        <h3>{{ cliente }}</h3>
        <table class="tabela-detalhes">
          <thead>
            <tr>
              <th></th>
              <th>Nº Pedido</th>
              <th>Paciente</th>
              <th>Data do Pedido</th>
              <th>Prazo</th>
              <th>Status</th>
              <th style="text-align:right;">Valor</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pedidos %}
            <tr class="accordion-row pedido-row {% if p.STATUS|lower == 'entregue' %}entregue{% endif %}">
              <td>
                <button class="accordion-btn" id="btn-{{ p.NR_PED }}" onclick="toggleItens('{{ p.NR_PED }}')">+</button>
              </td>
              <td>{{ p.NR_PED }}</td>
              <td>{{ p.PACIENTE }}</td>
              <td>{{ p.DT_PED|format_date_br }}</td>
              <td>{{ p.DT_PRAZO|format_date_br }}</td>
              <td>{{ p.STATUS }}</td>
              <td style="text-align:right;">{{ p.VLR_NUM|format_brl }}</td>
            </tr>
            <tr id="itens-{{ p.NR_PED }}" class="accordion-content">
              <td colspan="7">
                <div class="accordion-box conteudo-itens">
                  <em>Carregando itens...</em>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% else %}
    <p>Nenhum pedido encontrado para este filtro.</p>
  {% endif %}

  <a href="{{ url_for('index') }}" class="btn" style="margin-top:14px;">⬅ Voltar</a>

  <script>
    function toggleItens(nr_ped) {
      const row = document.getElementById("itens-" + nr_ped);
      const btn = document.getElementById("btn-" + nr_ped);
      const isHidden = row.style.display === "" || row.style.display === "none";

      if (isHidden) {
        fetch(`/itens/${nr_ped}`)
          .then(resp => resp.text())
          .then(html => {
            row.querySelector(".conteudo-itens").innerHTML = html;
            row.style.display = "table-row";
            btn.textContent = "−";
          })
          .catch(() => {
            row.querySelector(".conteudo-itens").innerHTML = "<p>Erro ao carregar itens.</p>";
            row.style.display = "table-row";
          });
      } else {
        row.style.display = "none";
        btn.textContent = "+";
      }
    }

    document.querySelectorAll(".accordion-content").forEach(r => r.style.display = "none");

    const toggle = document.getElementById("toggle-entregues");
	if (toggle) {
		toggle.addEventListener("change", function() {
		  if (this.checked) {
			window.location.href = "{{ url_for('detalhes', tipo='porcliente', filtro='todos') }}";
		  } else {
			window.location.href = "{{ url_for('detalhes', tipo='porcliente', filtro='naoentregues') }}";
		  }
		});
	  }
  </script>
{% endblock %}
