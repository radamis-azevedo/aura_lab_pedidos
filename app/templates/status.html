{% extends "base.html" %}

{% block title %}Status do Pedido #{{ nr_ped }}{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/status.css') }}">
{% endblock %}

{% block content %}
<div id="loader-overlay" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:9999; flex-direction:column; align-items:center; justify-content:center;">
    <div class="spinner"></div>
    <div class="loader-text">Processando...</div>
</div>

<div id="custom-modal" class="modal-overlay">
    <div class="modal-content">
        <span id="modal-icon" class="modal-icon">⚠️</span>
        <h3 id="modal-title" class="modal-title">Atenção</h3>
        <p id="modal-msg" class="modal-msg">Mensagem de erro aqui.</p>
        <button class="btn-modal-ok" onclick="closeModal()">Entendi</button>
    </div>
</div>

<div class="status-card">
    <h2 class="page-title">Histórico do Pedido #{{ "%02d"|format(nr_ped|int) }}</h2>

    {% if itens %}
    <h4 class="section-title"><i class="fas fa-compress-arrows-alt"></i> Resumo dos Itens</h4>
    <div class="table-scroll-wrapper">
      <table class="table-mini">
        <thead>
            <tr>
                <th>Produto</th>
                <th style="text-align: right;">Qtd</th>
                <th style="text-align: center;">Cor</th>
                <th style="text-align: right;">Valor</th>
                <th style="text-align: right;">Total</th>
            </tr>
        </thead>
        <tbody>
          {% for item in itens %}
          <tr>
            <td>{{ item.PRODUTO }}</td>
            <td style="text-align: right;">{{ item.QTD_ITEM }}</td>
            <td style="text-align: center;">{{ item.COR }}</td>
            <td style="text-align: right;">{{ item.VLR_COB|replace('R$', '')|trim }}</td>
            <td style="text-align: right;">{{ (item.TOTAL_VIEW or item.TOTAL_PROD)|replace('R$', '')|trim }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <h4 class="section-title"><i class="fas fa-history"></i> Linha do Tempo</h4>
    <div class="table-scroll-wrapper">
      <table class="table-emphasis">
        <thead>
            <tr>
                <th width="40"></th>
                <th>Status</th>
                <th>Início</th>
                <th>Prazo</th>
                <th>Prev. Entrega</th>
                <th>Obs</th>
                <th>Registro</th>
            </tr>
        </thead>
        <tbody>
          {% for h in historico %}
          <tr>
            <td>
                <button class="btn-edit-icon" title="Editar"
                        onclick="editarHistorico('{{ h.STATUS_HIST }}','{{ h.DT_HR_STATUS }}','{{ h.PRAZO_STATUS }}','{{ h.DT_HR_PRAZO }}','{{ h.OBS_STATUS }}','{{ h.row_index }}')">
                    ✏️
                </button>
            </td>
            <td><strong>{{ h.STATUS_HIST }}</strong></td>
            <td>{{ h.DT_HR_STATUS }}</td>
            <td>{% if h.PRAZO_STATUS %}{{ h.PRAZO_STATUS }} dias{% endif %}</td>
            <td>{{ h.DT_HR_PRAZO }}</td>
            <td style="color: #555; font-style: italic;">{{ h.OBS_STATUS }}</td>
            <td style="font-size: 0.75rem; color: #999;">
                {{ h.USUARIO }}<br>{{ h.DATA_HORA }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="margin-top: 15px;">
          {% for category, message in messages %}
            <div style="padding: 10px; border-radius: 6px; text-align: center; font-weight: bold; margin-bottom: 10px;
                 background: {% if category == 'success' %}#d4edda{% else %}#f8d7da{% endif %};
                 color: {% if category == 'success' %}#155724{% else %}#721c24{% endif %};">
                {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="status-form-box">
        <h3 id="form-title" style="color: #007bff; font-size: 1.1rem; margin-bottom: 15px; margin-top: 0;">
            <i class="fas fa-plus-circle"></i> Incluir Novo Status
        </h3>
        
        <form method="POST" id="status-form">
            <input type="hidden" id="row_index" name="row_index">
            
            <div class="form-row">
                <label>Status:</label>
                <select name="status" id="status" class="form-control" required>
                    <option value="">-- selecione --</option>
                    {% for s in status_options %}
                        <option value="{{ s }}">{{ s }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="row-flex">
                <div>
                    <label>Data/Hora Início:</label>
                    <input type="datetime-local" name="dt_hr_status" id="dt_hr_status" class="form-control" value="{{ now_str }}" required style="text-align: center;">
                </div>
                <div id="container-prazo" style="display:none;">
                    <label>Prazo (dias):</label>
                    <input type="number" name="prazo" id="prazo" class="form-control" min="0" max="99" style="text-align: right;">
                </div>
            </div>

            <div class="form-row" style="margin-top: 12px;">
                <label class="label-center">Observações:</label>
                <textarea name="obs" id="obs" rows="3" class="form-control"></textarea>
            </div>

            <div class="actions-footer">
                <div class="btn-group-main">
                    <button type="submit" id="save-btn" class="btn-save">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <button type="button" class="btn-cancel" onclick="resetarFormulario()">
                        Cancelar
                    </button>
                </div>

                <button type="submit" form="delete-form" id="delete-btn" class="btn-delete" style="display:none;" title="Excluir este Status">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<div class="btn-back-container">
    <a href="#" class="btn-back">⬅ Voltar ao Menu</a>
</div>

<form method="POST" id="delete-form" style="display:none;"></form>

{% endblock %}

{% block scripts %}
<script>
    window.StatusConfig = {
        nrPed: "{{ nr_ped }}",
        nowStr: "{{ now_str }}",
        dataLimite: "{{ data_limite_iso }}",
        statusPrazoObrig: {
            {% for s in status_options %}
            "{{ s }}": "{{ status_prazo_obrig.get(s, '') }}",
            {% endfor %}
        }
    };
</script>
<script src="{{ url_for('static', filename='js/status.js') }}"></script>
{% endblock %}