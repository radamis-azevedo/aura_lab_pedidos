<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Detalhes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo do Laboratório">
    </div>

    <h2 class="titulo-detalhes {{ tipo }}">{{ filtro|capitalize }}</h2>
    <hr>

    {% if agrupado %}
      {% for cliente, pedidos in agrupado.items() %}
        <div class="card cliente {{ tipo }}">
          <h3>{{ cliente }}</h3>

          <table class="tabela-detalhes">
            <thead>
              <tr>
                <th style="width:48px;"></th>
                <th>Nº Pedido</th>
                <th>Paciente</th>
                <th>Data do Pedido</th>
                <th>Prazo</th>
                <th>Status</th>
                <th style="text-align:right;">Valor</th>
              </tr>
            </thead>
            <tbody>
              {% for p in pedidos %}
              <!-- Linha principal do pedido (somente dados da aba PEDIDOS) -->
              <tr class="accordion-row">
                <td>
                  <button class="accordion-btn" id="btn-{{ p.NR_PED }}" onclick="toggleItens('{{ p.NR_PED }}')">+</button>
                </td>
                <td>{{ p.NR_PED }}</td>
                <td>{{ p.PACIENTE }}</td>
                <td>{{ p.DT_PED|format_date_br }}</td>
                <td>{{ p.DT_PRAZO|format_date_br }}</td>
                <td>{{ p.STATUS }}</td>
                <td style="text-align:right;">{{ p.VLR_NUM|format_brl }}</td>
              </tr>

              <!-- Linha oculta (expansão) com itens da aba PEDIDOS_ITENS -->
              <tr id="itens-{{ p.NR_PED }}" class="accordion-content">
                <td colspan="7">
                  <div class="accordion-box">
                    {% if p.ITENS and p.ITENS|length > 0 %}
                      <div class="itens-titulo">Itens do pedido {{ p.NR_PED }}</div>
                      <table class="tabela-itens">
                        <thead>
                          <tr>
                            <th>Produto</th>
                            <th>Qtd</th>
                            <th>Cor</th>
                            <th>Vlr Cobrado</th>
                            <th>Total</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for i in p.ITENS %}
                          <tr>
                            <td>{{ i.PRODUTO }}</td>
                            <td style="text-align:center;">{{ i.QTDE }}</td>
                            <td style="text-align:center;">{{ i.COR }}</td>
                            <td style="text-align:right;">{{ i.VLR_COB }}</td>
                            <td style="text-align:right;">{{ i.TOTAL_PROD }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    {% else %}
                      <em>Sem itens vinculados para este pedido.</em>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}
    {% else %}
      <p>Nenhum pedido encontrado para este filtro.</p>
    {% endif %}

    <a href="{{ url_for('index') }}" class="btn" style="margin-top:14px;">⬅ Voltar</a>
  </div>

  <script>
    function toggleItens(id) {
      const row = document.getElementById("itens-" + id);
      const btn = document.getElementById("btn-" + id);
      const isHidden = row.style.display === "" || row.style.display === "none";
      row.style.display = isHidden ? "table-row" : "none";
      btn.textContent = isHidden ? "−" : "+";
    }
    // Inicia todas as expansões escondidas
    document.querySelectorAll(".accordion-content").forEach(r => r.style.display = "none");
    
    function expandirItens(nr_ped, btn) {
    const linhaItens = btn.closest("tr").nextElementSibling;
    const container = linhaItens.querySelector(".conteudo-itens");

    if (linhaItens.style.display === "none") {
      // Carregar itens via rota /itens/<nr_ped>
      fetch(`/itens/${nr_ped}`)
        .then(resp => resp.text())
        .then(html => {
          container.innerHTML = html;
          linhaItens.style.display = "table-row";
          btn.textContent = "-"; // troca ícone
        });
    } else {
      linhaItens.style.display = "none";
      container.innerHTML = "";
      btn.textContent = "+";
    }
  }
  </script>



</body>
</html>
