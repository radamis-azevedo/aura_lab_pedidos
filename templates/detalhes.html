<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Pedidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <!-- Header com usuÃ¡rio e logout -->
    <div class="top-bar">
      <div class="logo">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo do LaboratÃ³rio">
      </div>
      {% if usuario %}
      <div class="user-info">
        <span>ðŸ‘¤ {{ usuario }}</span>
        <a href="{{ url_for('logout') }}" class="btn-small">Sair</a>
      </div>
      {% endif %}
    </div>

    <!-- TÃ­tulo -->
    <h2 class="titulo-detalhes {{ tipo }}">{{ filtro }}</h2>
    <hr>

    <!-- Switch (sÃ³ aparece para o card porcliente) -->
    {% if tipo == "porcliente" %}
    <div class="switch-box">
      <label class="switch">
        <input type="checkbox" id="toggle-entregues"
               {% if "todos" in filtro|lower %}checked{% endif %}>
        <span class="slider round"></span>
      </label>
      <span class="switch-label">Mostrar pedidos entregues</span>
    </div>
    {% endif %}

    <!-- ConteÃºdo -->
    {% if agrupado %}
      {% for cliente, pedidos in agrupado.items() %}
        <div class="card cliente {{ tipo }}">
          <h3>{{ cliente }}</h3>
          <div class="table-wrapper">
            <table class="tabela-detalhes">
              <thead>
                <tr>
                  <th class="col-btn"></th> <!-- coluna do botÃ£o + -->
                  <th>#</th>
				  <th>Status</th>
                  <th>Paciente</th>
                  <th>Data Ped</th>
				  <th>Prazo</th>
                  <th style="text-align:right;">Valor</th>
                </tr>
              </thead>
              <tbody>
                {% for p in pedidos %}
                <tr class="accordion-row pedido-row {% if p.STATUS|lower == 'entregue' %}entregue{% endif %}">
                  <td>
                    <button class="accordion-btn" id="btn-{{ p.NR_PED }}" onclick="toggleItens('{{ p.NR_PED }}')">+</button>
                  </td>
                  <td>{{ p.NR_PED }}</td>
                  <td>
					{% if p.STATUS|lower == "entregue" %}
						<a href="{{ url_for('status_pedido', nr_ped=p.NR_PED) }}" class="status-link">âœ…</a> {{ p.STATUS }}
					{% elif p.STATUS|lower == "atrasado" %}
						<a href="{{ url_for('status_pedido', nr_ped=p.NR_PED) }}" class="status-link">ðŸ”´</a> {{ p.STATUS }}
					{% else %}
						<a href="{{ url_for('status_pedido', nr_ped=p.NR_PED) }}" class="status-link">ðŸŸ¡</a> {{ p.STATUS }}
					{% endif %}
				  </td>

				  <td>{{ p.PACIENTE }}</td>
                  <td>{{ p.DT_PED|format_date_br }}</td>
                  <td>{{ p.DT_PRAZO|format_date_br }}</td>
                  <td style="text-align:right;">{{ p.VLR_NUM|format_brl }}</td>
                </tr>

                <!-- Linha oculta (expansÃ£o com itens) -->
                <tr id="itens-{{ p.NR_PED }}" class="accordion-content">
                  <td colspan="7">
                    <div class="accordion-box conteudo-itens">
                      <em>Carregando itens...</em>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>Nenhum pedido encontrado para este filtro.</p>
    {% endif %}

    <a href="{{ url_for('index') }}" class="btn" style="margin-top:14px;">â¬… Voltar</a>
  </div>

  <!-- Script -->
  <script>
    // ðŸ”¹ Event delegation para botÃµes accordion
    document.addEventListener("click", e => {
      if (e.target.classList.contains("accordion-btn")) {
        const nr_ped = e.target.dataset.ped;
        toggleItens(nr_ped, e.target);
      }
    });


  function toggleItens(nr_ped) {
    const row = document.getElementById("itens-" + nr_ped);
    const btn = document.getElementById("btn-" + nr_ped);
    const isHidden = row.style.display === "" || row.style.display === "none";

    if (isHidden) {
      fetch(`/itens/${nr_ped}`)
        .then(async resp => {
          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`HTTP ${resp.status} - ${text.substring(0, 200)}`);
          }
          return resp.text();
        })
        .then(html => {
          row.querySelector(".conteudo-itens").innerHTML = html;
          row.style.display = "table-row";
          btn.textContent = "âˆ’";
        })
        .catch(err => {
          console.error("Erro ao carregar itens:", err);
          row.querySelector(".conteudo-itens").innerHTML =
            `<p style="color:#b02a37;">Erro ao carregar itens: ${err.message}</p>`;
          row.style.display = "table-row";
          btn.textContent = "âˆ’";
        });
    } else {
      row.style.display = "none";
      btn.textContent = "+";
    }
  }


    // ðŸ”¹ Inicia todas as expansÃµes escondidas
    document.querySelectorAll(".accordion-content").forEach(r => r.style.display = "none");

    // ðŸ”¹ Controle do switch (para pedidos entregues)
    const toggle = document.getElementById("toggle-entregues");
    if (toggle) {
      toggle.addEventListener("change", function() {
        if (this.checked) {
          window.location.href = "{{ url_for('detalhes', tipo='porcliente', filtro='todos') }}";
        } else {
          window.location.href = "{{ url_for('detalhes', tipo='porcliente', filtro='naoentregues') }}";
        }
      });
    }
  </script>
</body>
</html>
