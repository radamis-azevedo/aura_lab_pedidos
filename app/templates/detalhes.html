{% extends "base.html" %}

{% block title %}Detalhes - {{ filtro }}{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/detalhes.css') }}">
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    
    <h3 style="color:#007bff; font-weight:bold; margin:0;">{{ filtro }}</h3>

    {% if tipo == 'porcliente' %}
    <div class="switch-box" style="margin:0;">
        <label class="switch">
            <input type="checkbox" id="toggleEntregues" 
                   {% if filtro|lower == 'todos' %}checked{% endif %}
                   onchange="toggleFilter(this)">
            <span class="slider round"></span>
        </label>
        <span class="switch-label">Mostrar entregues</span>
    </div>
    {% endif %}

</div>

{% if modo_view == 'lista' %}
    
    {% for cliente, lista_pedidos in agrupado.items() %}
    <div class="client-card">
        <div class="client-header">
            {{ cliente }}
        </div>

       <div class="table-scroll">
            <table class="table-lista">
                <thead>
                    <tr>
                        <th class="col-action"></th>
                        <th class="col-id">#</th>
                        <th class="col-status">Status</th>
                        <th class="col-paciente">Paciente</th>
                        <th class="col-valor hide-mobile">Valor</th>
                        <th class="col-data hide-mobile">Data</th> 
                    </tr>
                </thead>
                <tbody>
                    {% for p in lista_pedidos %}
                    <tr>
                        <td class="col-action">
                            <button type="button" class="btn-toggle-mini" 
                                    onclick="toggleDetails('details-{{ p.NR_PED }}')">
                                <i class="fas fa-plus"></i>
                            </button>
                        </td>

                        <td class="col-id">
                            <a href="{{ url_for('orders.editar_pedido', nr_ped=p.NR_PED) }}" class="order-link" title="Editar Pedido">
                                {{ "%03d"|format(p.NR_PED|int) }}
                            </a>
                        </td>

                        <td class="col-status">
                            <div class="status-wrapper">
                                <a href="{{ url_for('orders.status_pedido', nr_ped=p.NR_PED) }}" 
                                   style="text-decoration:none; margin-right: 2px;" 
                                   title="Ver Histórico">
                                    {% set cor_status = '#6c757d' %}
                                    {% if 'entregue' in p.STATUS|lower or 'finalizado' in p.STATUS|lower %}
                                        {% set cor_status = '#28a745' %}
                                    {% elif 'produ' in p.STATUS|lower %}
                                        {% set cor_status = '#ffc107' %}
                                    {% elif 'atrasado' in p.STATUS|lower %}
                                        {% set cor_status = '#dc3545' %}
                                    {% endif %}
                                    <i class="fas fa-circle" style="font-size: 0.65rem; color: {{ cor_status }};"></i>
                                </a>

                                <span class="status-text">{{ p.STATUS }}</span>
                                
                                <a href="{{ url_for('orders.pagamento_pedido', nr_ped=p.NR_PED) }}" style="text-decoration:none;">
                                    {% if p.PAGO|lower in ['sim','s','true'] %}
                                        <i class="fas fa-check-circle text-success" style="font-size:0.9rem;"></i>
                                    {% else %}
                                        <i class="fas fa-sack-dollar icon-money"></i>
                                    {% endif %}
                                </a>
                            </div>
                        </td>

                        <td class="col-paciente">
                            {{ p.PACIENTE or '' }}
                        </td>

                        <td class="col-valor hide-mobile">
                            R$ {{ "{:,.2f}".format(p.VLR_NUM|default(0)|float).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                        </td>

                        <td class="col-data hide-mobile">
                            {{ p.DT_PEDIDO|default('-', true) }}
                        </td>
                    </tr>

                    <tr id="details-{{ p.NR_PED }}" class="details-row">
                        <td colspan="6">
                            <div class="details-box">
                                
                                {% if p.ITENS %}
                                <div class="scroll-wrapper">
                                    <table class="mini-table">
                                        <thead>
                                            <tr>
                                                <th>Produto</th>
                                                <th class="num">Qtd</th>
                                                <th style="text-align:center;">Cor</th>
                                                <th class="num">Unit.</th>
                                                <th class="num">Total</th>
                                                <th>Obs</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in p.ITENS %}
                                            <tr>
                                                <td><strong>{{ item.PRODUTO }}</strong></td>
                                                <td class="num">{{ item.QTD_ITEM }}</td>
                                                <td style="text-align:center;">{{ item.COR }}</td>
                                                
                                                <td class="num">
                                                    {{ item.VLR_COB|replace('R$', '')|replace(' ', '') }}
                                                </td>
                                                
                                                <td class="num text-blue">
                                                    {% if item.TOTAL_VIEW %}
                                                        {{ item.TOTAL_VIEW|replace('R$', '')|replace(' ', '') }}
                                                    {% else %}
                                                        {{ item.TOTAL_PROD|replace('R$', '')|replace(' ', '') }}
                                                    {% endif %}
                                                </td>
                                                
                                                <td class="obs">{{ item.OBS_ITEM }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                    <div style="font-style:italic; color:#999; margin-bottom:10px;">Sem produtos cadastrados.</div>
                                {% endif %}

                                {% if p.CUSTOS %}
                                <div class="scroll-wrapper gap-top">
                                    <table class="mini-table">
                                        <thead>
                                            <tr>
                                                <th style="color:#dc3545;">Terceirização / Custo</th> 
                                                <th class="num">Qtd</th>
                                                <th class="num">Unit.</th>
                                                <th class="num">Total</th>
                                                <th>Obs</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for c in p.CUSTOS %}
                                            <tr>
                                                <td>{{ c.DESC_CUSTO }}</td>
                                                <td class="num">{{ c.QTD_CUSTO }}</td>
                                                <td class="num">
                                                    {{ c.VLR_UN_CUSTO|replace('R$', '')|replace(' ', '') }}
                                                </td>
                                                <td class="num text-red">
                                                    {% if c.TOTAL_VIEW %}
                                                        {{ c.TOTAL_VIEW|replace('R$', '')|replace(' ', '') }}
                                                    {% else %}
                                                        {{ c.VLR_TOT_CUSTO|replace('R$', '')|replace(' ', '') }}
                                                    {% endif %}
                                                </td>
                                                <td class="obs">{{ c.OBS_CUSTO }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}

                                {% if p.OBS_PED %}
                                    <div style="margin-top:10px; font-size:0.85rem; color:#444;">
                                        <span style="font-weight:bold; color:#dc3545;">Obs:</span> {{ p.OBS_PED }}
                                    </div>
                                {% endif %}

                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}

{% else %}
    {% endif %}
<div class="text-center mt-5 mb-5">
        <a href="{{ url_for('dashboard.index') }}" class="back-btn" style="padding: 10px 30px; font-size: 1rem;">
            <i class="fas fa-arrow-left"></i> Voltar ao Menu
        </a>
    </div>

{% endblock %}


{% block scripts %}
<script>
    // 1. Função para abrir/fechar os detalhes do pedido (Botão +)
    function toggleDetails(id) {
        var row = document.getElementById(id);
        if (row.style.display === "none" || row.style.display === "") {
            row.style.display = "table-row";
        } else {
            row.style.display = "none";
        }
    }

    // 2. Função para o Switch "Mostrar Entregues"
    function toggleFilter(checkbox) {
        if (checkbox.checked) {
            // Se marcou: Recarrega a página mostrando TODOS
            window.location.href = "{{ url_for('orders.detalhes', tipo='porcliente', filtro='todos') }}";
        } else {
            // Se desmarcou: Recarrega mostrando apenas NÃO ENTREGUES
            window.location.href = "{{ url_for('orders.detalhes', tipo='porcliente', filtro='naoentregues') }}";
        }
    }
</script>
{% endblock %}