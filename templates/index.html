{% extends "base.html" %}

{% block title %}Gest√£o de Pedidos{% endblock %}

{% block content %}
  <h1>Gest√£o de Pedidos</h1>
  <hr>

  <!-- Bot√£o de ativar/desativar drag-and-drop -->
  <button id="toggle-dnd" class="btn-small">üîÄ Reordenar Cards</button>

  <!-- GRADE DE CARDS -->
  <div class="grid">
    
    <!-- Card 1: Pedidos a Receber -->
    <div id="card-receber" data-id="card-receber" class="card">
      <div class="card-header">
        <h2>üìå Pedidos a Receber</h2>
      </div>
      <div class="card-body">
        <ul class="list">
          {% for cliente, dados in clientes_devedores.items() %}
          <li class="cliente-row">
            <span class="cliente-info">{{ dados["titulo"] }}</span>
            <span class="valor-info">{{ dados["valor"]|format_brl }}</span>
          </li>
          {% endfor %}

          <!-- Linha final com bot√£o e total -->
          <li class="total-row">
            <a href="{{ url_for('areceber') }}" class="btn-small">Detalhes</a>
            <span>Total Clientes: {{ total_receber_val|format_brl }}</span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Card 2: Menu -->
    <div id="card-menu" data-id="card-menu" class="card">
      <h2>üìÇ Menu</h2>
      <div class="menu-btns">
        <a href="{{ url_for('detalhes', tipo='porcliente', filtro='naoentregues') }}" class="btn">Pedidos por Cliente</a>
        <a href="#" class="btn">Op√ß√£o 2</a>
        <a href="#" class="btn">Op√ß√£o 3</a>
      </div>
    </div>

    <!-- Card 3: Prazo de Entrega -->
    <div id="card-prazo" data-id="card-prazo" class="card">
      <h2>‚è≥ Prazo de Entrega</h2>
      <ul class="list">
        <li>
          <div>
            <b>J√° era pra serem entregues:</b>
            {{ prazos["atrasados"]["qtd"] }} ({{ prazos["atrasados"]["val"]|format_brl }})
          </div>
          <a href="{{ url_for('detalhes', tipo='prazo', filtro='atrasados') }}" class="btn-small">Detalhes</a>
        </li>
        <li>
          <div>
            <b>Para HOJE:</b>
            {{ prazos["hoje"]["qtd"] }} ({{ prazos["hoje"]["val"]|format_brl }})
          </div>
          <a href="{{ url_for('detalhes', tipo='prazo', filtro='hoje') }}" class="btn-small">Detalhes</a>
        </li>
        <li>
          <div>
            <b>A partir de amanh√£:</b>
            {{ prazos["futuros"]["qtd"] }} ({{ prazos["futuros"]["val"]|format_brl }})
          </div>
          <a href="{{ url_for('detalhes', tipo='prazo', filtro='futuro') }}" class="btn-small">Detalhes</a>
        </li>
      </ul>
    </div>

    <!-- Card 4: Status -->
    <div id="card-status" data-id="card-status" class="card">
      <h2>üìä Por Status</h2>
      <ul class="list">
        {% for status, dados in status_map.items() %}
        <li>
          <div>
            <b>{{ status }}:</b> {{ dados["qtd"] }} ({{ dados["val"]|format_brl }})
          </div>
          <a href="{{ url_for('detalhes', tipo='status', filtro=status) }}" class="btn-small">Detalhes</a>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>


  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const grid = document.querySelector(".grid");
      const toggleDnD = document.getElementById("toggle-dnd");

      // Inicializa SortableJS (desktop + mobile)
      const sortable = new Sortable(grid, {
        animation: 150,
        disabled: true, // come√ßa desativado
        onEnd: salvarOrdem
      });

      // Alterna drag-and-drop ao clicar no bot√£o
		let dragEnabled = false;

		toggleDnD.addEventListener("click", () => {
		  dragEnabled = !dragEnabled;
		  sortable.option("disabled", !dragEnabled); // agora respeita o estado real
		  toggleDnD.textContent = dragEnabled ? "‚úÖ Reordene os Cards" : "üîÄ Reordenar Cards";
		});


      // Fun√ß√£o para salvar ordem no backend
      function salvarOrdem() {
        const ordem = [...grid.querySelectorAll(".card")].map(c => c.id);
        fetch("/salvar_layout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ordem })
        });
      }

      // üîπ Reordenar conforme salvo no backend
      const ordemSalva = {{ ordem_salva|tojson }};
      if (ordemSalva.length > 0) {
        ordemSalva.forEach(cardId => {
          const card = document.getElementById(cardId);
          if (card) grid.appendChild(card);
        });
      }
    });
  </script>
{% endblock %}
