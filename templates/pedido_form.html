<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>{% if modo == 'editar' %}Editar Pedido #{{ "%02d"|format(nr_ped|int) }}{% else %}Novo Pedido{% endif %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    input, select, textarea { padding: 4px 6px; }
    input[type="number"], .num { text-align: right; font-weight: bold; }
    .btn-add { padding: 4px 8px; font-size: 0.8em; margin-left: 6px; }
    .table-wrapper { width: 100%; overflow-x: auto; }
    .itens-table th, .itens-table td { white-space: nowrap; }
    .feedback-box {
      display:none; margin:10px 0; padding:10px; border-radius:8px;
      font-weight:500; text-align:center;
    }
    .feedback-box.sucesso { background:#d4edda; color:#155724; }
    .feedback-box.erro { background:#f8d7da; color:#721c24; }
    .feedback-box.alerta { background:#fff3cd; color:#856404; }
  </style>
</head>
<body>
  <!-- TOPO -->
  <div class="top-bar">
    <div class="logo">
      <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='logo.png') }}" alt="Logo"></a>
    </div>
    <div class="user-info">
      <span>{{ usuario }}</span>
      <a href="{{ url_for('logout') }}" class="btn-small">Sair</a>
    </div>
  </div>

  <div class="status-container">
    <h2 class="status-header">
      {% if modo == 'editar' %}‚úèÔ∏è Editar Pedido #{{ "%02d"|format(nr_ped|int) }}{% else %}‚ûï Cadastrar Novo Pedido{% endif %}
    </h2>

    <div id="feedback" class="feedback-box"></div>

    <!-- ‚úÖ FORM CORRIGIDO -->
    <form id="pedidoForm" method="POST" class="status-form">

      <!-- Data Pedido -->
      <div class="form-row">
        <label>
          Data do Pedido:
          {% if modo == 'editar' %}
            <input type="datetime-local" id="dt_pedido_display" value="{{ dt_pedido }}" class="input-readonly" disabled>
            <input type="hidden" id="dt_pedido" name="dt_pedido" value="{{ dt_pedido }}">
          {% else %}
            <input type="datetime-local" id="dt_pedido" name="dt_pedido" value="{{ dt_pedido }}" required>
          {% endif %}
        </label>
      </div>

      <!-- Cliente -->
      <div class="form-row">
        <label>
          Cliente:
          <select name="cliente" id="cliente" required>
            <option value="">-- selecione --</option>
            {% for c in clientes %}
              <option value="{{ c }}" {% if c == cliente_atual %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </label>
      </div>

      <!-- Paciente -->
      <div class="form-row">
        <label>
          Paciente:
          <input type="text" name="paciente" id="paciente" value="{{ paciente_atual }}" required>
        </label>
      </div>

      <!-- Observa√ß√£o Pedido -->
      <div class="form-row">
        <label>
          Observa√ß√£o do Pedido:
          <input type="text" name="obs_ped" id="obs_ped" value="{{ obs_atual }}">
        </label>
      </div>

      <!-- Itens -->
      <h3>Itens do Pedido</h3>
      <div class="form-row">
        <label style="flex:1">
          Produto:
          <select id="produto">
            <option value="">-- selecione --</option>
            {% for p in produtos %}
              <option value="{{ p.PRODUTO }}" data-vlr="{{ p.VLR_CAT }}">{{ p.PRODUTO }} - {{ p.VLR_CAT }}</option>
            {% endfor %}
          </select>
        </label>
      </div>
      <div class="form-row same-line">
        <label>Cor: <input type="text" id="cor"></label>
        <label>Qtd: <input type="number" id="qtde" min="1"></label>
        <label>Valor: <input type="text" id="valor_cobrado" class="num"></label>
      </div>
      <div class="form-row same-line">
        <label style="flex:1">Obs: <input type="text" id="obs_item"></label>
        <button type="button" class="btn-small add-btn" onclick="adicionarItem()">‚ûï</button>
      </div>

      <div class="table-wrapper">
        <table class="itens-table big-table" id="tabela-itens">
          <thead>
            <tr><th>Produto</th><th>Qtd</th><th>Cor</th><th>Valor</th><th>Total</th><th>Obs</th><th></th></tr>
          </thead>
          <tbody>
            {% for i in itens %}
            <tr data-json='{{ {"produto":i.PRODUTO,"qtde":i.QTD_ITEM,"cor":i.COR,"valor":i.VLR_COB,"obs":i.OBS_ITEM}|tojson }}'>
              <td>{{ i.PRODUTO }}</td>
              <td>{{ i.QTD_ITEM }}</td>
              <td>{{ i.COR }}</td>
              <td>{{ i.VLR_COB }}</td>
              <td>{{ i.TOTAL_VIEW}}</td>
              <td>{{ i.OBS_ITEM }}</td>
              <td><button type="button" onclick="removerLinha(this)">‚ùå</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Custos -->
      <h3>
        Terceiriza√ß√£o
        <label class="switch">
          <input type="checkbox" id="toggle-custos" onchange="toggleCustos()" {% if custos and custos|length > 0 %}checked{% endif %}>
          <span class="slider"></span>
        </label>
      </h3>
      <div id="custos-section" style="display:none;">
        <div class="form-row same-line">
          <label style="flex:1">Descri√ß√£o: <input type="text" id="desc-custo"></label>
          <label>Qtd: <input type="number" id="qtd-custo" min="1"></label>
          <label>Valor Un: <input type="text" id="valor-custo" class="num"></label>
        </div>
        <div class="form-row same-line">
          <label style="flex:1">Obs: <input type="text" id="obs-custo"></label>
          <button type="button" class="btn-small add-btn" onclick="adicionarCusto()">‚ûï</button>
        </div>
        <div class="table-wrapper">
          <table class="itens-table big-table" id="tabela-custos">
            <thead>
              <tr><th>Descri√ß√£o</th><th>Total</th><th>Obs</th><th></th></tr>
            </thead>
            <tbody>
              {% for c in custos %}
              <tr data-json='{{ {"desc":c.DESC_CUSTO,"qtd":c.QTD_CUSTO,"valor":c.VLR_UN_CUSTO,"obs":c.OBS_CUSTO}|tojson }}'>
                <td>{{ c.DESC_CUSTO }}</td>
                <td>{{ c.TOTAL_VIEW }}</td>
                <td>{{ c.OBS_CUSTO }}</td>
                <td><button type="button" onclick="removerLinha(this)">‚ùå</button></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <input type="hidden" name="itens_json" id="itens_json">
      <input type="hidden" name="custos_json" id="custos_json">

      <div class="form-row" style="margin-top:20px;">
        <button id="btnSalvar" type="submit" class="btn">üíæ Salvar</button>
        {% if modo == 'editar' %}
        <button type="button" class="btn-delete" onclick="excluirPedido('{{ nr_ped }}')">üóëÔ∏è Excluir Pedido</button>
        {% endif %}
        <a href="{{ url_for('index') }}" class="cancel-btn">‚¨Ö Voltar</a>
      </div>
    </form>
  </div>

<script>

// --- Armazena o estado inicial do pedido ao carregar a tela ---
let estadoInicial = {};

function capturarEstadoAtual() {
  const cliente = document.getElementById("cliente")?.value || "";
  const paciente = document.getElementById("paciente")?.value || "";
  const obs = document.getElementById("obs_ped")?.value || "";

  const itens = Array.from(document.querySelectorAll("#tabela-itens tbody tr"))
    .map(tr => JSON.parse(tr.dataset.json || "{}"));
  const custos = Array.from(document.querySelectorAll("#tabela-custos tbody tr"))
    .map(tr => JSON.parse(tr.dataset.json || "{}"));

  return { cliente, paciente, obs, itens, custos };
}

document.addEventListener("DOMContentLoaded", () => {
  // Salva o estado inicial logo ap√≥s carregar
  estadoInicial = capturarEstadoAtual();
});

// --- Compara o estado atual com o inicial ---
function houveAlteracao() {
  const atual = capturarEstadoAtual();
  return JSON.stringify(atual) !== JSON.stringify(estadoInicial);
}
</script>


<script>
  const feedback = document.getElementById("feedback");
  const btnSalvar = document.getElementById("btnSalvar");

  function mostrarMensagem(msg, tipo="alerta") {
    feedback.textContent = msg;
    feedback.className = "feedback-box " + tipo;
    feedback.style.display = "block";
  }

  function formatarNumero(v) {
    const n = parseFloat((v || "0").replace(",", "."));
    return isNaN(n) ? "" : n.toFixed(2).replace(".", ",");
  }

  document.getElementById("produto").addEventListener("change", function() {
    const opt = this.options[this.selectedIndex];
    const vlr = opt.getAttribute("data-vlr") || "";
    if (vlr) {
      // Remove R$, espa√ßos e troca v√≠rgula por ponto
      const normalizado = vlr.replace(/[R$\s]/g, "");
      document.getElementById("valor_cobrado").value = normalizado;
    }
  });

  function calcularTotalItem(qtde, valor) {
    const q = parseFloat(qtde.replace(",", ".")) || 0;
    const v = parseFloat(valor.replace(",", ".")) || 0;
    return (q * v).toFixed(2).replace(".", ",");
  }

  function limparCamposItem() {
    document.getElementById("produto").value = "";
    document.getElementById("qtde").value = "";
    document.getElementById("cor").value = "";
    document.getElementById("valor_cobrado").value = "";
    document.getElementById("obs_item").value = "";
    document.getElementById("produto").focus();
  }

  function adicionarItem() {
    const produto = document.getElementById("produto").value.trim();
    const qtde = document.getElementById("qtde").value.trim();
    const cor = document.getElementById("cor").value.trim();
    const valor = document.getElementById("valor_cobrado").value.trim();
    const obs = document.getElementById("obs_item").value.trim();

    // üîí Valida√ß√£o
    if (!produto || !qtde || !valor) {
      mostrarMensagem("‚ö†Ô∏è Informe Produto, Quantidade e Valor!", "alerta");
      document.getElementById("produto").focus();
      return;
    }

    // üî¢ C√°lculo de total
    const q = parseFloat(qtde.replace(",", ".")) || 0;
    const v = parseFloat(valor.replace(",", ".")) || 0;
    const total = (q * v).toFixed(2).replace(".", ",");

    // üß± Cria√ß√£o da linha
    const tbody = document.querySelector("#tabela-itens tbody");
    const tr = document.createElement("tr");

    // üîπ Guarda o JSON completo (para salvar na planilha)
    tr.dataset.json = JSON.stringify({ produto, qtde, cor, valor, obs });

    // üîπ Monta a linha visual
    tr.innerHTML = `
      <td>${produto}</td>
      <td>${qtde}</td>
      <td>${cor}</td>
      <td>${v.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}</td>
      <td>${total.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}</td>
      <td>${obs}</td>
      <td><button type="button" onclick="removerLinha(this)">‚ùå</button></td>
    `;

    // üß© Adiciona √† tabela
    tbody.appendChild(tr);

    // ‚úÖ Limpa campos e foca no produto
    limparCamposItem();

    // ‚úÖ Feedback visual
    mostrarMensagem("‚úÖ Item adicionado com sucesso!", "sucesso");

    // üü¢ Habilita o bot√£o Salvar ao adicionar o primeiro item
    btnSalvar.disabled = false;
  }

  function adicionarCusto() {
    const desc = document.getElementById("desc-custo").value.trim();
    const qtd = document.getElementById("qtd-custo").value.trim();
    const valor = document.getElementById("valor-custo").value.trim();
    const obs = document.getElementById("obs-custo").value.trim();
    if (!desc || !qtd || !valor) {
      mostrarMensagem("‚ö†Ô∏è Informe Descri√ß√£o, Quantidade e Valor Unit√°rio!", "alerta");
      return;
    }
    const total = calcularTotalItem(qtd, valor);
    const tbody = document.querySelector("#tabela-custos tbody");
    const tr = document.createElement("tr");
    tr.dataset.json = JSON.stringify({ desc, qtd, valor, obs });
    tr.innerHTML = `<td>${desc}</td><td>${total}</td><td>${obs}</td>
                    <td><button type="button" onclick="removerLinha(this)">‚ùå</button></td>`;
    tbody.appendChild(tr);
    document.getElementById("desc-custo").value = "";
    document.getElementById("qtd-custo").value = "";
    document.getElementById("valor-custo").value = "";
    document.getElementById("obs-custo").value = "";
    mostrarMensagem("üí∞ Custo adicionado!", "sucesso");
  }

  function removerLinha(btn) {
    btn.closest("tr").remove();
    mostrarMensagem("üóëÔ∏è Item removido.", "alerta");

    // üî¥ Desativa o bot√£o salvar se todos os itens forem removidos
    const itensRestantes = document.querySelectorAll("#tabela-itens tbody tr").length;
    if (itensRestantes === 0) {
      btnSalvar.disabled = true;
    }
  }

  function toggleCustos() {
    document.getElementById("custos-section").style.display =
      document.getElementById("toggle-custos").checked ? "block" : "none";
  }

  function prepararEnvio() {
    const itens = Array.from(document.querySelectorAll("#tabela-itens tbody tr"))
      .map(tr => JSON.parse(tr.dataset.json));
    const custos = Array.from(document.querySelectorAll("#tabela-custos tbody tr"))
      .map(tr => JSON.parse(tr.dataset.json));

    if (itens.length === 0) {
      mostrarMensagem("‚ö†Ô∏è Inclua pelo menos um item antes de salvar.", "erro");
      document.getElementById("produto").focus();
      return false;
    }

    document.getElementById("itens_json").value = JSON.stringify(itens);
    document.getElementById("custos_json").value = JSON.stringify(custos);
    return true;
  }

  window.addEventListener("DOMContentLoaded", () => {
    {% if modo == 'novo' %}
      btnSalvar.disabled = true;  // ‚õî come√ßa desativado
      document.getElementById("toggle-custos").checked = false;
    {% endif %}
    toggleCustos();
  });

  window.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('toggle-custos');
    if (toggle.checked) {
      document.getElementById('custos-section').style.display = 'block';
    }
  });
</script>

<script>
document.getElementById("pedidoForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!prepararEnvio()) return;

  if (!houveAlteracao()) {
    mostrarMensagem("‚ö†Ô∏è Nenhuma altera√ß√£o detectada.", "alerta");
    return;
  }


  const formData = new FormData(e.target);
  const response = await fetch(window.location.pathname, {
    method: "POST",
    body: formData
  });

  const result = await response.json().catch(() => ({}));

if (result.sucesso) {
  {% if modo == 'editar' %}
    mostrarPopupEdicao(result.nr_ped);
  {% else %}
    mostrarPopupSucesso(result.nr_ped);
  {% endif %}
} else {
  mostrarMensagem("‚ùå Erro ao salvar o pedido.", "erro");
}

});

function mostrarPopupSucesso(nr_ped) {
  // cria o cont√™iner
  const popup = document.createElement("div");
  popup.classList.add("popup-overlay");
  popup.innerHTML = `
    <div class="popup-content">
      <h3>‚úÖ Pedido #${nr_ped} inclu√≠do com sucesso!</h3>
      <p>Aguardando a pr√≥xima atualiza√ß√£o do STATUS.</p>
      <p><b>O que voc√™ deseja fazer agora?</b></p>
      <div class="popup-buttons">
        <button onclick="fecharPopup(() => window.location.href='/novo_pedido')" class="btn">‚ûï Incluir Novo Pedido</button>
        <button onclick="fecharPopup(() => irParaStatus(${nr_ped}))" class="btn">üîÑ Atualizar STATUS</button>
        <button onclick="fecharPopup(() => window.location.href='/')" class="btn">üè† Voltar ao In√≠cio</button>
      </div>
    </div>
  `;
  document.body.appendChild(popup);

  // for√ßa reflow e adiciona classe de fade-in
  requestAnimationFrame(() => popup.classList.add("visible"));
}
function mostrarPopupEdicao(nr_ped) {
  const popup = document.createElement("div");
  popup.classList.add("popup-overlay");
  popup.innerHTML = `
    <div class="popup-content">
      <h3>‚úÖ Pedido #${nr_ped} atualizado com sucesso!</h3>
      <p>Todas as altera√ß√µes foram salvas na planilha.</p>
      <p><b>O que voc√™ deseja fazer agora?</b></p>
      <div class="popup-buttons">
        <button onclick="fecharPopup(() => voltarTelaAnterior())" class="btn">‚¨Ö Voltar para tela anterior</button>
        <button onclick="fecharPopup(() => irParaStatus(${nr_ped}))" class="btn">üîÑ Atualizar STATUS</button>
      </div>
    </div>
  `;
  document.body.appendChild(popup);
  requestAnimationFrame(() => popup.classList.add("visible"));
}

function voltarTelaAnterior() {
  const ultima = sessionStorage.getItem("ultima_rota");
  if (ultima && ultima !== window.location.pathname) {
    window.location.href = ultima;
  } else {
    window.location.href = "/";
  }
}

function irParaStatus(nr_ped) {
  // ‚úÖ Garante que o status.html saiba voltar corretamente
  const ultima = sessionStorage.getItem("ultima_rota");
  if (!ultima || (!ultima.includes("/detalhes") && ultima !== "/")) {
    // Se o usu√°rio chegou direto (sem detalhes), define index como origem padr√£o
    sessionStorage.setItem("ultima_rota", "/");
  }
  window.location.href = `/status/${nr_ped}`;
}


// remove com fade-out antes do redirecionamento
function fecharPopup(callback) {
  const popup = document.querySelector(".popup-overlay");
  if (!popup) return;
  popup.classList.remove("visible");
  popup.classList.add("fade-out");
  setTimeout(() => {
    popup.remove();
    if (callback) callback();
  }, 400); // dura√ß√£o igual √† anima√ß√£o CSS
}

async function excluirPedido(nr_ped) {
  if (!confirm(`‚ö†Ô∏è Deseja realmente excluir o pedido #${nr_ped}? Essa a√ß√£o n√£o pode ser desfeita.`)) return;

  try {
    const resp = await fetch(`/api/excluir_pedido/${nr_ped}`, { method: "DELETE" });
    const data = await resp.json();

    if (data.ok) {
      mostrarPopupExclusao(nr_ped, data.msg);
    } else {
      mostrarMensagem("‚ùå Erro ao excluir o pedido: " + data.msg, "erro");
    }
  } catch (e) {
    mostrarMensagem("‚ùå Falha ao comunicar com o servidor.", "erro");
    console.error(e);
  }
}

function mostrarPopupExclusao(nr_ped, msg) {
  const popup = document.createElement("div");
  popup.classList.add("popup-overlay");
  popup.innerHTML = `
    <div class="popup-content">
      <h3>üóëÔ∏è Pedido #${nr_ped} exclu√≠do</h3>
      <p>${msg}</p>
      <p><b>O que voc√™ deseja fazer agora?</b></p>
      <div class="popup-buttons">
        <button onclick="fecharPopup(() => voltarTelaAnterior())" class="btn">‚¨Ö Voltar para tela anterior</button>
        <button onclick="fecharPopup(() => window.location.href='/')" class="btn">üè† Ir para o In√≠cio</button>
      </div>
    </div>`;
  document.body.appendChild(popup);
  requestAnimationFrame(() => popup.classList.add("visible"));
}

</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const voltarBtn = document.querySelector(".cancel-btn, .back-btn");
  if (!voltarBtn) return;

  voltarBtn.addEventListener("click", (e) => {
    e.preventDefault();
    document.body.classList.add("fade-out");

    const ultima = sessionStorage.getItem("ultima_rota");
    setTimeout(() => {
      if (ultima && (ultima.includes("/detalhes") || ultima === "/")) {
        window.location.href = ultima;
      } else {
        window.location.href = "/";
      }
    }, 300);
  });
});

</script>

<style>
/* Anima√ß√£o suave ao sair da p√°gina */
body.fade-out {
  opacity: 0;
  transition: opacity 0.3s ease;
}
</style>


<style>
/* === anima√ß√µes do popup === */
.popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.4s ease;
  z-index: 9999;
}
.popup-overlay.visible {
  opacity: 1;
}
.popup-overlay.fade-out {
  opacity: 0;
}

.popup-content {
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  max-width: 420px;
  width: 90%;
  text-align: center;
  box-shadow: 0 8px 25px rgba(0,0,0,0.25);
  transform: translateY(-20px);
  animation: slideUp 0.4s ease forwards;
}
@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.popup-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}
.popup-buttons .btn {
  background: #007bff;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 10px;
  cursor: pointer;
  transition: background 0.2s;
}
.popup-buttons .btn:hover {
  background: #0056b3;
}
</style>


</body>
</html>