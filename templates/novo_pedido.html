<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Novo Pedido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    input, select, textarea { padding: 4px 6px; }
    input[type="number"], .num { text-align: right; font-weight: bold; }
    .btn-add { padding: 4px 8px; font-size: 0.8em; margin-left: 6px; }
    .table-wrapper { width: 100%; overflow-x: auto; }
    .itens-table th, .itens-table td { white-space: nowrap; }
  </style>
</head>
<body>
  <!-- TOPO -->
  <div class="top-bar">
    <div class="logo">
      <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='logo.png') }}" alt="Logo"></a>
    </div>
    <div class="user-info">
      <span>{{ usuario }}</span>
      <a href="{{ url_for('logout') }}" class="btn-small">Sair</a>
    </div>
  </div>

  <div class="status-container">
    <h2 class="status-header">‚ûï Cadastrar Novo Pedido</h2>

    <!-- üîî FEEDBACK -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- FORMUL√ÅRIO -->
    <form method="POST" class="status-form" onsubmit="return prepararEnvio()">

      <!-- Data Pedido -->
      <div class="form-row">
        <label>
          Data do Pedido:
          <input type="datetime-local" id="dt_pedido" name="dt_pedido" value="{{ agora_str }}" required>
        </label>
      </div>

      <!-- Cliente -->
      <div class="form-row">
        <label>
          Cliente:
          <select name="cliente" id="cliente" required>
            <option value="">-- selecione --</option>
            {% for c in clientes %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </label>
      </div>

      <!-- Paciente -->
      <div class="form-row">
        <label>
          Paciente:
          <input type="text" name="paciente" id="paciente" required>
        </label>
      </div>

      <!-- Observa√ß√£o Pedido -->
      <div class="form-row">
        <label>
          Observa√ß√£o do Pedido:
          <input type="text" name="obs_ped" id="obs_ped">
        </label>
      </div>

      <!-- Itens do Pedido -->
      <h3>Itens do Pedido</h3>
      <div class="form-row">
        <label style="flex:1">
          Produto:
          <select id="produto">
            <option value="">-- selecione --</option>
            {% for p in produtos %}
              <option value="{{ p.nome }}" data-vlr="{{ p.vlr_cat }}">{{ p.nome }} (R$ {{ p.vlr_cat }})</option>
            {% endfor %}
          </select>
        </label>
      </div>

      <div class="form-row same-line">
        <label>Cor: <input type="text" id="cor"></label>
        <label>Qtd: <input type="number" id="qtde" min="1"></label>
        <label>Valor: <input type="text" id="valor_cobrado" class="num"></label>
      </div>

      <div class="form-row same-line">
        <label style="flex:1">Obs: <input type="text" id="obs_item"></label>
        <button type="button" class="btn-small add-btn" onclick="adicionarItem()">+</button>
      </div>

      <div class="table-wrapper">
        <table class="itens-table big-table" id="tabela-itens">
          <thead>
            <tr>
              <th>Produto</th>
              <th>Qtd</th>
              <th>Cor</th>
              <th>Valor Cobrado</th>
              <th>Total Produto</th>
              <th>Obs</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Custos -->
      <h3>
        Terceiriza√ß√£o
        <label class="switch">
          <input type="checkbox" id="toggle-custos" onchange="toggleCustos()">
          <span class="slider"></span>
        </label>
      </h3>

      <div id="custos-section" style="display:none;">
        <div class="form-row">
          <label style="flex:1">Descri√ß√£o: <input type="text" id="desc-custo"></label>
        </div>
        <div class="form-row same-line">
          <label>Qtd: <input type="number" id="qtd-custo" min="1"></label>
          <label>Valor Un: <input type="text" id="valor-custo" class="num"></label>
          <label>Total: <input type="text" id="total-custo" class="num" readonly></label>
        </div>
        <div class="form-row same-line">
          <label style="flex:1">Obs: <input type="text" id="obs-custo"></label>
          <button type="button" class="btn-small add-btn" onclick="adicionarCusto()">+</button>
        </div>
        <div class="table-wrapper">
          <table class="itens-table big-table" id="tabela-custos">
            <thead>
              <tr>
                <th>Descri√ß√£o</th>
                <th>Total</th>
                <th>Obs</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Campos ocultos JSON -->
      <input type="hidden" name="itens_json" id="itens_json">
      <input type="hidden" name="custos_json" id="custos_json">

      <button type="submit">Salvar Pedido</button>
      <a href="{{ url_for('index') }}" class="cancel-btn">Cancelar</a>
    </form>
  </div>

  <script>
    function validarDadosPrincipais() {
      return document.getElementById("dt_pedido").value &&
             document.getElementById("cliente").value &&
             document.getElementById("paciente").value;
    }

    // Produto -> valor cat√°logo
    document.getElementById("produto").addEventListener("change", function() {
      const opt = this.options[this.selectedIndex];
      const vlr = opt.getAttribute("data-vlr");
      if (vlr) document.getElementById("valor_cobrado").value = vlr;
    });

    // Custos: calcular total
    document.getElementById("qtd-custo").addEventListener("input", calcularTotalCusto);
    document.getElementById("valor-custo").addEventListener("input", calcularTotalCusto);
    function calcularTotalCusto() {
      const qtd = parseInt(document.getElementById("qtd-custo").value) || 0;
      const vlr = parseFloat(document.getElementById("valor-custo").value.replace(",", ".") || 0);
      document.getElementById("total-custo").value = (qtd * vlr).toFixed(2).replace(".", ",");
    }

    function toggleCustos() {
      document.getElementById("custos-section").style.display =
        document.getElementById("toggle-custos").checked ? "block" : "none";
    }

    // Adicionar item
    function adicionarItem() {
      if (!validarDadosPrincipais()) {
        alert("‚ö†Ô∏è Preencha Data, Cliente e Paciente antes de incluir itens.");
        return;
      }
      const produto = document.getElementById("produto").value;
      const qtde = document.getElementById("qtde").value;
      const cor = document.getElementById("cor").value;
      const valor = document.getElementById("valor_cobrado").value;
      const obs = document.getElementById("obs_item").value;
      if (!produto || !qtde || !valor) {
        alert("‚ö†Ô∏è Informe Produto, Qtd e Valor.");
        return;
      }
      const total = (parseFloat(valor.replace(",", ".")) * parseInt(qtde)).toFixed(2).replace(".", ",");
      const tbody = document.querySelector("#tabela-itens tbody");
      const row = tbody.insertRow();
      row.dataset.json = JSON.stringify({produto, qtde, cor, valor, obs});
      row.insertCell(0).innerText = produto;
      row.insertCell(1).innerText = qtde;
      row.insertCell(2).innerText = cor;
      row.insertCell(3).innerText = valor;
      row.insertCell(4).innerText = total;
      row.insertCell(5).innerText = obs;
      row.insertCell(6).innerHTML = "<button type='button' onclick='removerLinha(this)'>‚ùå</button>";
      document.getElementById("produto").value = "";
      document.getElementById("qtde").value = "";
      document.getElementById("cor").value = "";
      document.getElementById("valor_cobrado").value = "";
      document.getElementById("obs_item").value = "";
    }

    // Adicionar custo
    function adicionarCusto() {
      if (!validarDadosPrincipais()) {
        alert("‚ö†Ô∏è Preencha Data, Cliente e Paciente antes de incluir custos.");
        return;
      }
      const desc = document.getElementById("desc-custo").value;
      const qtd = document.getElementById("qtd-custo").value;
      const valor = document.getElementById("valor-custo").value;
      const obs = document.getElementById("obs-custo").value;
      if (!desc || !qtd || !valor) {
        alert("‚ö†Ô∏è Informe Descri√ß√£o, Qtd e Valor Un.");
        return;
      }
      const total = document.getElementById("total-custo").value;
      const tbody = document.querySelector("#tabela-custos tbody");
      const row = tbody.insertRow();
      row.dataset.json = JSON.stringify({desc, qtd, valor, obs});
      row.insertCell(0).innerText = desc;
      row.insertCell(1).innerText = total;
      row.insertCell(2).innerText = obs;
      row.insertCell(3).innerHTML = "<button type='button' onclick='removerLinha(this)'>‚ùå</button>";
      document.getElementById("desc-custo").value = "";
      document.getElementById("qtd-custo").value = "";
      document.getElementById("valor-custo").value = "";
      document.getElementById("total-custo").value = "";
      document.getElementById("obs-custo").value = "";
    }

    // Remover linha
    function removerLinha(btn) {
      btn.closest("tr").remove();
    }

    // Antes de enviar -> compilar JSONs
    function prepararEnvio() {
      const itens = Array.from(document.querySelectorAll("#tabela-itens tbody tr"))
        .map(tr => JSON.parse(tr.dataset.json));
      const custos = Array.from(document.querySelectorAll("#tabela-custos tbody tr"))
        .map(tr => JSON.parse(tr.dataset.json));
      document.getElementById("itens_json").value = JSON.stringify(itens);
      document.getElementById("custos_json").value = JSON.stringify(custos);
      return true;
    }
  </script>
</body>
</html>
